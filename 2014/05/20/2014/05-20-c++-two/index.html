<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 令人纠结的两行代码 · Qiyexuxu</title><meta name="description" content="令人纠结的两行代码 - David Wang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.keeplearning.group/atom.xml" title="Qiyexuxu"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/abnerwang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">令人纠结的两行代码</h1><div class="tags"><a href="/tags/C/" class="tag-title">#C++</a></div><div class="post-info">May 20, 2014</div><div class="post-content"><p>主要参考资料：我在 Stackoverflow 上提的问题 <a href="http://stackoverflow.com/questions/23749546/why-the-first-is-right-but-the-second-is-wrong" target="_blank" rel="noopener">Why the first is right but the second is wrong ?</a></p>
<a id="more"></a>
<p>这令人纠结的两行代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *cval = <span class="string">"nothing"</span>;  <span class="comment">// 正确</span></span><br><span class="line"><span class="keyword">int</span> *ival = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;      <span class="comment">// 错误</span></span><br></pre></td></tr></table></figure>
<p>为什么第一行代码正确第二行代码错误呢？既然 “nothing” 在内存中是以数组的形式存储的，那么，为什么可以定义一个 cval 指向它而不能对应地定义一个 ival 指向下面的数组呢？这确实是一个很让人纠结的问题，看下面的分析吧：</p>
<p>首先我们来看第一行代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *cval = <span class="string">"nothing"</span>;</span><br></pre></td></tr></table></figure>
<p>赋值运算符右侧是一个 <strong>字符串字面值常量</strong> ，编译器将字符串字面值常量放在内存空间中的一段连续的地址单元进行存储，且 <strong>存储的类型为 const char[]</strong> ，存储的形式是： <code>{&#39;n&#39;, &#39;o&#39;, &#39;t&#39;, &#39;h&#39;, &#39;i&#39;, &#39;n&#39;, &#39;g&#39;, &#39;&#39;}</code> ，这一点很重要，将赋值运算符右侧的字符串字面值赋给左侧的运算对象时，const char[] 类型将向 const char* 进行转换，由于数组名本身就是一个指针，因此这种转换是合理的，合法的，所以这部分代码是正确的；</p>
<p>再来看看以下的这部分代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *ival = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>这部分代码怎么是错的了？这是因为，编译器不允许单独将 {1, 2, 3, 4} 存储到内存中，而必须将其拷贝到某一个对象对应的连续的地址单元，显然，赋值运算符右边只是一个指向 int 的指针类型，不具备存储 {1, 2, 3, 4} 的条件，所以，这部分代码是错误的。<br>由于在 C 语言中，从 C99 以后，有一个称之为 compund literal 的特性，所以对于第 2 行的代码，在 C 中我们可进行如下修改使其正确：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *ival = (<span class="keyword">int</span> []) &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>上面的这行代码在 C++ 中是不成立的，有错误产生，想想为什么呢？这是因为 C 和 C++ 的语言特性是不一样的，在 C 中，上面代码中的赋值运算符右侧是一个持久的值，是一个常量对象，它被创建的时候有着持久的地址，但是，在 C++ 中，右侧运算对象只是一个临时对象，不具备持久的地址，在 <code>(int []) {1, 2, 3, 4}</code>这个表达式结束时地址已经消亡，我个人认为，这是 C 和 C++ 语言<strong>右值</strong> 规范上的差别，对于这点理由欢迎提供不同参考意见。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2014/05/21/2014/05-21-c++-range-for/" class="prev">上一篇</a><a href="/2014/05/13/2014/05-13-android-mac/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'abnerwang';
var disqus_identifier = '2014/05/20/2014/05-20-c++-two/';
var disqus_title = '令人纠结的两行代码';
var disqus_url = 'http://blog.keeplearning.group/2014/05/20/2014/05-20-c++-two/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//abnerwang.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2018 <a href="http://blog.keeplearning.group">David Wang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/x-mathjax-config">MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
tex2jax: { inlineMath: [ ["$", "$"], ["\\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
TeX: { noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
messageStyle: "none"
});
</script></body></html>